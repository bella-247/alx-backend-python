pipeline {
agent any


environment {
    // Jenkins credentials for DockerHub and GitHub
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
    GITHUB_CREDENTIALS = credentials('github-credentials')

    DOCKERHUB_USERNAME = "${DOCKERHUB_CREDENTIALS_USR}"
    DOCKERHUB_PASSWORD = "${DOCKERHUB_CREDENTIALS_PSW}"
    IMAGE_NAME = "messaging_app"
    REPO_URL = "https://github.com/<your-username>/alx-backend-python.git"
}

stages {

    stage('Checkout Code') {
        steps {
            echo 'Cloning repository from GitHub...'
            git branch: 'main', credentialsId: 'github-credentials', url: "${REPO_URL}"
        }
    }

    stage('Install Dependencies') {
        steps {
            echo 'Installing dependencies...'
            sh '''
                python3 -m venv venv
                . venv/bin/activate
                pip3 install --upgrade pip
                pip3 install -r messaging_app/requirements.txt
                pip3 install pytest pytest-django
            '''
        }
    }

    stage('Run Tests') {
        steps {
            echo 'Running pytest...'
            sh '''
                . venv/bin/activate
                pytest messaging_app --junitxml=report.xml
            '''
        }
        post {
            always {
                echo 'Archiving test reports...'
                junit 'report.xml'
            }
        }
    }

    stage('Build Docker Image') {
        steps {
            echo 'Building Docker image...'
            sh '''
                docker build -t ${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest .
            '''
        }
    }

    stage('Push Docker Image') {
        steps {
            echo 'Pushing image to DockerHub...'
            sh '''
                echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
                docker push ${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest
            '''
        }
    }
}

post {
    success {
        echo 'Pipeline completed successfully ✅'
    }
    failure {
        echo 'Pipeline failed ❌ — check logs for details.'
    }
}

}
